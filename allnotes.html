<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>所有筆記</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">

<div class="max-w-5xl mx-auto">

  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-purple-700">所有筆記</h1>
    <a href="main.html" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-full">回我的筆記</a>
  </div>

  <input id="searchNotes" placeholder="搜尋筆記" class="w-full mb-6 p-2 border rounded-lg">

  <!-- 所有筆記區 -->
  <div id="allNotesList" class="space-y-4"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain: "classquest-419e1.firebaseapp.com",
  projectId: "classquest-419e1",
  storageBucket: "classquest-419e1.firebasestorage.app",
  messagingSenderId: "18905423391",
  appId: "1:18905423391:web:37c3aa41f021430f27ff2a",
  measurementId: "G-0H7STZJVXS"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, user => {
  if (!user) { window.location.href = "index.html"; return; }
  const uid = auth.currentUser.uid;

  // 監聽所有筆記
  const allNotesQuery = query(collection(db, "notes"), orderBy("createdAt", "desc"));
  onSnapshot(allNotesQuery, snapshot => {
    allNotesList.innerHTML = "";
    snapshot.forEach(docItem => {
      const d = docItem.data();
      const isMine = d.uid === uid;

      const card = document.createElement("div");
      card.className = `p-4 rounded-2xl shadow-md hover:shadow-lg transition ${isMine ? "bg-yellow-100" : "bg-white"}`;

      const contentDiv = document.createElement("div");
      contentDiv.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <h4 class="font-semibold text-lg">${d.title || "(無標題)"}</h4>
          <span class="text-sm text-gray-500">${isMine ? "(自己)" : "他人"}</span>
        </div>
        <div class="text-gray-700 mb-2">${d.content || "(無內容)"}</div>
      `;
      card.appendChild(contentDiv);

      if (d.imageBase64) {
        const img = document.createElement("img");
        img.src = d.imageBase64;
        img.className = "max-w-full rounded-lg mt-2";
        card.appendChild(img);
      }

      if (isMine) {
        const btnContainer = document.createElement("div");
        btnContainer.className = "mt-2 flex gap-2";

        const editBtn = document.createElement("button");
        editBtn.textContent = "修改";
        editBtn.className = "bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-full";

        const delBtn = document.createElement("button");
        delBtn.textContent = "刪除";
        delBtn.className = "bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full";
        delBtn.onclick = async () => { await deleteDoc(doc(db, "notes", docItem.id)); };

        editBtn.onclick = () => {
          // 變成富文字編輯器
          contentDiv.innerHTML = `
            <input type="text" id="editTitle" value="${d.title}" class="w-full mb-2 p-1 border rounded-lg">
            <div class="flex gap-2 mb-1">
              <select id="fontSize" class="border rounded px-1">
                <option value="3">中</option>
                <option value="4">大</option>
                <option value="5">更大</option>
              </select>
              <input type="color" id="fontColor" class="w-10 h-7 p-0 border rounded">
              <button type="button" onclick="document.execCommand('bold')" class="px-2 py-1 bg-gray-200 rounded">B</button>
              <button type="button" onclick="document.execCommand('italic')" class="px-2 py-1 bg-gray-200 rounded">I</button>
              <button type="button" onclick="document.execCommand('insertLineBreak')" class="px-2 py-1 bg-gray-200 rounded">換行</button>
            </div>
            <div id="editableContent" contenteditable="true" class="w-full p-2 border rounded-lg bg-white min-h-[100px]">${d.content}</div>
          `;

          const saveBtn = document.createElement("button");
          saveBtn.textContent = "確定";
          saveBtn.className = "bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-full mt-2";
          saveBtn.onclick = async () => {
            const newTitle = document.getElementById("editTitle").value;
            const newContent = document.getElementById("editableContent").innerHTML;
            await updateDoc(doc(db, "notes", docItem.id), { title: newTitle, content: newContent });
          };
          contentDiv.appendChild(saveBtn);

          // 設定工具列事件
          const fontSize = contentDiv.querySelector("#fontSize");
          const fontColor = contentDiv.querySelector("#fontColor");
          const editableContent = contentDiv.querySelector("#editableContent");

          fontSize.onchange = () => document.execCommand("fontSize", false, fontSize.value);
          fontColor.oninput = () => document.execCommand("foreColor", false, fontColor.value);
        };

        btnContainer.appendChild(editBtn);
        btnContainer.appendChild(delBtn);
        card.appendChild(btnContainer);
      }

      allNotesList.appendChild(card);
    });
  });
});

// 搜尋功能
searchNotes.oninput = () => {
  const keyword = searchNotes.value.toLowerCase();
  allNotesList.querySelectorAll("div").forEach(card => {
    const title = card.querySelector("h4").innerText.toLowerCase();
    const content = card.querySelector("#editableContent")?.innerText.toLowerCase() || card.querySelector("div")?.innerText.toLowerCase() || "";
    card.style.display = title.includes(keyword) || content.includes(keyword) ? "block" : "none";
  });
};
</script>
</body>
</html>
