<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>所有筆記</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>

<body class="bg-gray-100">

<div class="max-w-5xl mx-auto p-6 space-y-4">

  <h1 class="text-3xl font-bold">所有筆記</h1>

  <a href="main.html" class="underline text-blue-600">返回主頁</a>

  <div id="notes" class="space-y-4"></div>

</div>

<!-- modal -->
<div id="imgModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
  <img id="modalImg" class="max-h-[90vh] rounded-xl">
</div>

<script>
  const firebaseConfig = {
    // 你的 firebase
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  auth.onAuthStateChanged(user=>{
    db.collection("notes").orderBy("createdAt","desc").onSnapshot(snap=>{
      notes.innerHTML = "";

      snap.forEach(doc=>{
        const d = doc.data();
        const isMine = d.uid === user.uid;

        notes.innerHTML += `
          <div class="p-4 rounded-2xl shadow bg-white border ${isMine ? "border-yellow-400" : ""}">
            <h2 class="font-bold text-xl">${d.title||"未命名"}</h2>

            <div id="content-${doc.id}" class="mt-2">${d.content}</div>

            <!-- 附件 -->
            <div class="mt-3">
              ${(d.attachments||[]).map((img,idx)=>`
                <div class="p-2 bg-blue-50 rounded mt-1 cursor-pointer"
                     onclick="openImg('${img}')">
                  附件圖片 ${idx+1}
                </div>
              `).join("")}
            </div>

            ${isMine ? `
            <div id="toolbar-${doc.id}" class="hidden mt-2 flex gap-2">
              <button onclick="execCmd('${doc.id}','bold')" class="px-2 border rounded">B</button>
              <button onclick="execCmd('${doc.id}','italic')" class="px-2 border rounded">I</button>
              <input type="color" onchange="execCmd('${doc.id}','foreColor',this.value)">
            </div>

            <div class="flex gap-2 mt-3 justify-end">
              <button onclick="enableEdit('${doc.id}')"
                      class="px-3 py-1 bg-blue-500 text-white rounded">修改</button>

              <button onclick="saveEdit('${doc.id}')"
                      class="px-3 py-1 bg-green-600 text-white rounded">儲存</button>

              <button onclick="deleteNote('${doc.id}')"
                      class="px-3 py-1 bg-red-600 text-white rounded">刪除</button>
            </div>
            ` : ""}

          </div>
        `;
      });
    });
  });

  window.enableEdit = id=>{
    const c = document.getElementById("content-"+id);
    c.contentEditable = true;
    c.classList.add("border","p-2");
    document.getElementById("toolbar-"+id).classList.remove("hidden");
  };

  window.execCmd = (id,cmd,val=null)=>{
    document.getElementById("content-"+id).focus();
    document.execCommand(cmd,false,val);
  };

  window.saveEdit = async id=>{
    const c = document.getElementById("content-"+id);
    await db.collection("notes").doc(id).update({
      content: c.innerHTML
    });
    c.contentEditable = false;
  };

  window.deleteNote = id=>{
    db.collection("notes").doc(id).delete();
  };

  window.openImg = src=>{
    modalImg.src = src;
    imgModal.classList.remove("hidden");
    imgModal.classList.add("flex");
  };
  imgModal.onclick = ()=> imgModal.classList.add("hidden");

</script>
</body>
</html>
