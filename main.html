<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>NoteNote - Main</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100">

<div class="max-w-4xl mx-auto p-6 space-y-6">
  <h1 class="text-3xl font-bold">NoteNote 主頁</h1>

  <!-- 標題 -->
  <input id="titleInput" placeholder="標題"
         class="w-full p-2 border rounded">

  <!-- 富文字工具列 -->
  <div class="flex gap-2 mt-2">
    <select id="fontSize" class="border rounded p-1">
      <option value="">字體大小</option>
      <option value="10">10px</option>
      <option value="12">12px</option>
      <option value="14">14px</option>
      <option value="16">16px</option>
      <option value="18">18px</option>
      <option value="20">20px</option>
      <option value="22">22px</option>
      <option value="24">24px</option>
      <option value="26">26px</option>
      <option value="28">28px</option>
    </select>
    <button id="boldBtn" class="px-2 border rounded font-bold">B</button>
    <button id="italicBtn" class="px-2 border rounded italic">I</button>
    <input type="color" id="colorPicker">
  </div>

  <!-- 內容編輯器 -->
  <div id="editor"
       class="w-full h-40 border rounded p-3 bg-white overflow-auto"
       contenteditable="true"></div>

  <!-- 附件區 -->
  <div class="mt-3">
    <input type="file" multiple accept="image/*" id="imgUpload">
    <div id="attachmentsPreview" class="mt-2 flex flex-wrap gap-2"></div>
  </div>

  <button id="saveNote" class="px-4 py-2 bg-blue-600 text-white rounded mt-2">
    儲存筆記
  </button>

  <div class="mt-2">
    <a href="allnotes.html" class="underline text-blue-500 mr-4">查看所有筆記</a>
    <a href="search.html" class="underline text-blue-500">搜尋筆記</a>
  </div>

  <!-- 聊天室 -->
  <div class="mt-6">
    <h2 class="font-bold text-xl">聊天室</h2>
    <div id="chatBox" class="h-60 overflow-y-auto border rounded p-3 bg-white"></div>
    <div class="flex mt-2 gap-2">
      <input id="chatInput" class="flex-1 border rounded p-2">
      <button id="sendChat" class="px-4 bg-green-600 text-white rounded">送出</button>
    </div>
  </div>
</div>

<!-- 圖片放大 Modal -->
<div id="imgModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
  <img id="modalImg" class="max-h-[90vh] rounded-xl">
</div>

<script>
const firebaseConfig = {
  // 你的 firebase 設定
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
auth.signInAnonymously();

const editor = document.getElementById("editor");
const attachmentsPreview = document.getElementById("attachmentsPreview");
let attachments = [];

// 富文字功能
fontSize.onchange = e => {
  const size = e.target.value;
  if(size){
    document.execCommand("fontSize", false, 7); // 用最大值 7
    // 將剛選取文字換成自訂大小
    const span = document.createElement("span");
    span.style.fontSize = size+"px";
    span.innerHTML = window.getSelection().toString();
    const range = window.getSelection().getRangeAt(0);
    range.deleteContents();
    range.insertNode(span);
  }
};
boldBtn.onclick = () => document.execCommand("bold");
italicBtn.onclick = () => document.execCommand("italic");
colorPicker.onchange = e => document.execCommand("foreColor", false, e.target.value);

// 附件功能
imgUpload.onchange = e => {
  for (let f of e.target.files) {
    const r = new FileReader();
    r.onload = ev => {
      attachments.push(ev.target.result);
      const div = document.createElement("div");
      div.className = "relative w-24 h-24 border rounded overflow-hidden";
      div.innerHTML = `
        <img src="${ev.target.result}" class="object-cover w-full h-full cursor-pointer" onclick="openImg('${ev.target.result}')">
        <button class="absolute top-0 right-0 bg-red-500 text-white rounded px-1" onclick="removeAttachment('${ev.target.result}')">X</button>
      `;
      attachmentsPreview.appendChild(div);
    };
    r.readAsDataURL(f);
  }
};

window.removeAttachment = src => {
  attachments = attachments.filter(x => x!==src);
  attachmentsPreview.innerHTML = "";
  attachments.forEach(a=>{
    const div = document.createElement("div");
    div.className = "relative w-24 h-24 border rounded overflow-hidden";
    div.innerHTML = `
      <img src="${a}" class="object-cover w-full h-full cursor-pointer" onclick="openImg('${a}')">
      <button class="absolute top-0 right-0 bg-red-500 text-white rounded px-1" onclick="removeAttachment('${a}')">X</button>
    `;
    attachmentsPreview.appendChild(div);
  });
};

// 儲存筆記
saveNote.onclick = async () => {
  const user = auth.currentUser;
  await db.collection("notes").add({
    uid: user.uid,
    title: titleInput.value,
    content: editor.innerHTML,
    attachments: attachments,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  titleInput.value = "";
  editor.innerHTML = "";
  attachments = [];
  attachmentsPreview.innerHTML = "";
};

// 聊天室
function scrollBottom(){ chatBox.scrollTop = chatBox.scrollHeight; }

sendChat.onclick = async () => {
  const u = auth.currentUser;
  await db.collection("chat").add({
    uid: u.uid,
    text: chatInput.value,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  chatInput.value = "";
};

db.collection("chat").orderBy("createdAt").onSnapshot(snap=>{
  chatBox.innerHTML = "";
  const docs = snap.docs.slice(-200);
  docs.forEach(d=>{
    chatBox.innerHTML += `<div class="p-2 bg-white rounded border mb-1">${d.data().text}</div>`;
  });
  scrollBottom();
});

// 圖片放大
window.openImg = src => {
  modalImg.src = src;
  imgModal.classList.remove("hidden");
  imgModal.classList.add("flex");
};
imgModal.onclick = ()=> imgModal.classList.add("hidden");

</script>
</body>
</html>
