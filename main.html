<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Notenote - 主頁</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat 版本 -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="max-w-6xl mx-auto p-4 space-y-6">

    <!-- Header -->
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold">Notenote</h1>
      <div class="space-x-2">
        <a href="allnotes.html" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">所有筆記</a>
        <a href="search.html" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">搜尋</a>
      </div>
    </div>

    <!-- 建立筆記區 -->
    <div class="bg-white rounded-2xl shadow p-4 space-y-3">
      <h2 class="font-semibold text-lg">建立筆記</h2>
      <input id="titleInput" class="w-full border rounded-xl p-2" placeholder="標題">

      <!-- 富文字工具列 -->
      <div class="flex flex-wrap gap-2 items-center bg-gray-50 p-2 rounded-xl border">
        <select id="fontSize" class="border rounded-xl p-1">
          <option value="1">10</option><option value="2">12</option><option value="3">14</option>
          <option value="4">16</option><option value="5">18</option><option value="6">20</option>
          <option value="7">22</option><option value="8">24</option><option value="9">28</option>
          <option value="10">32</option>
        </select>
        <input id="colorPicker" type="color" class="w-8 h-8 rounded">
        <button id="boldBtn" class="px-3 py-1 rounded-xl bg-gray-200 hover:bg-gray-300">B</button>
        <button id="italicBtn" class="px-3 py-1 rounded-xl bg-gray-200 hover:bg-gray-300">I</button>
        <label class="cursor-pointer px-3 py-1 rounded-xl bg-green-500 text-white hover:bg-green-600">
          圖片
          <input id="imageInput" type="file" accept="image/*" class="hidden">
        </label>
      </div>

      <!-- 編輯區 -->
      <div id="editor" contenteditable="true" class="min-h-[150px] border rounded-2xl p-3 bg-white shadow-inner"></div>

      <button id="saveNote" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">儲存筆記</button>
    </div>

    <!-- 我的筆記 -->
    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-3">我的筆記</h2>
      <div id="myNotes" class="grid md:grid-cols-2 gap-4"></div>
    </div>

    <!-- 聊天室 -->
    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-3">聊天室</h2>
      <div id="chatBox" class="h-64 overflow-y-auto space-y-2 border rounded-2xl p-3 bg-gray-50"></div>
      <div class="mt-3 flex gap-2">
        <input id="chatInput" class="flex-1 border rounded-xl p-2" placeholder="輸入訊息…">
        <button id="sendChat" class="px-4 py-2 bg-blue-600 text-white rounded-xl">送出</button>
      </div>
    </div>

  </div>

  <script type="module">
    const firebaseConfig = {
  apiKey: "AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain: "classquest-419e1.firebaseapp.com",
  projectId: "classquest-419e1",
  storageBucket: "classquest-419e1.firebasestorage.app",
  messagingSenderId: "18905423391",
  appId: "1:18905423391:web:37c3aa41f021430f27ff2a",
  measurementId: "G-0H7STZJVXS"
};

    // 初始化 Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // 富文字工具
    const editor = document.getElementById("editor");
    document.getElementById("fontSize").onchange = (e) => document.execCommand("fontSize", false, e.target.value);
    document.getElementById("boldBtn").onclick = () => document.execCommand("bold");
    document.getElementById("italicBtn").onclick = () => document.execCommand("italic");
    document.getElementById("colorPicker").onchange = (e) => document.execCommand("foreColor", false, e.target.value);

    // 圖片插入
    const imageInput = document.getElementById("imageInput");
    imageInput.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = document.createElement("img");
        img.src = ev.target.result;
        img.className = "max-w-full rounded-xl mt-2";
        editor.appendChild(img);
      };
      reader.readAsDataURL(file);
    };

    // 儲存筆記
    const titleInput = document.getElementById("titleInput");
    const saveNote = document.getElementById("saveNote");
    saveNote.onclick = async () => {
      const user = auth.currentUser;
      if (!user) return alert("請先登入！");
      await db.collection("notes").add({
        uid: user.uid,
        title: titleInput.value,
        content: editor.innerHTML,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      editor.innerHTML = "";
      titleInput.value = "";
    };

    // 顯示我的筆記
    const myNotes = document.getElementById("myNotes");
    auth.onAuthStateChanged(user => {
      if (!user) return;
      db.collection("notes")
        .where("uid", "==", user.uid)
        .orderBy("createdAt", "desc")
        .onSnapshot(snap => {
          myNotes.innerHTML = "";
          snap.forEach(doc => {
            const d = doc.data();
            myNotes.innerHTML += `
              <div class="rounded-2xl shadow p-4 bg-yellow-50 border">
                <div class="flex justify-between">
                  <h3 class="font-semibold">${d.title || "未命名"}</h3>
                </div>
                <div class="mt-2">${d.content}</div>
                <div class="mt-3 flex gap-2 justify-end">
                  <button onclick="deleteNote('${doc.id}')" class="px-3 py-1 bg-red-500 text-white rounded-xl">刪除</button>
                </div>
              </div>
            `;
          });
        });
    });

    window.deleteNote = async (id) => {
      await db.collection("notes").doc(id).delete();
    };

    // 聊天室
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const sendChat = document.getElementById("sendChat");

    function scrollBottom() { chatBox.scrollTop = chatBox.scrollHeight; }

    sendChat.onclick = async () => {
      const user = auth.currentUser;
      if (!user) return alert("請先登入！");
      await db.collection("chat").add({
        uid: user.uid,
        name: user.displayName,
        text: chatInput.value,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      chatInput.value = "";
    };

    db.collection("chat").orderBy("createdAt").onSnapshot(snap => {
      chatBox.innerHTML = "";
      const docs = snap.docs;
      const start = Math.max(0, docs.length - 200);
      docs.slice(start).forEach(doc => {
        const d = doc.data();
        chatBox.innerHTML += `
          <div class="bg-white rounded-xl shadow p-2">
            <div class="text-sm text-gray-500">${d.name || "User"}</div>
            <div>${d.text}</div>
          </div>
        `;
      });
      scrollBottom();
    });
  </script>
</body>
</html>
