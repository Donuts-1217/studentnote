<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>NoteNote - Main</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>

<body class="bg-gray-100">

<div class="max-w-4xl mx-auto p-6 space-y-6">

  <h1 class="text-3xl font-bold">NoteNote 主頁</h1>

  <!-- 文字編輯器工具列 -->
  <div class="flex gap-2">
    <select id="fontSize" class="border rounded p-1">
      <option value="3">字體大小</option>
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
      <option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option>
    </select>

    <button id="boldBtn" class="px-2 border rounded">粗體</button>
    <button id="italicBtn" class="px-2 border rounded">斜體</button>

    <input type="color" id="colorPicker">
  </div>

  <!-- 標題 -->
  <input id="titleInput" placeholder="標題"
         class="w-full p-2 border rounded">

  <!-- 內容編輯器 -->
  <div id="editor"
       class="w-full h-40 border rounded p-3 bg-white overflow-auto"
       contenteditable="true"></div>

  <!-- 圖片附件 -->
  <div>
    <input type="file" multiple accept="image/*" id="imgUpload">
    <div id="attachmentsPreview" class="mt-2 space-y-2"></div>
  </div>

  <button id="saveNote"
          class="px-4 py-2 bg-blue-600 text-white rounded">
    儲存筆記
  </button>

  <a href="allnotes.html" class="underline text-blue-500 ml-3">查看所有筆記</a>
  <a href="search.html" class="underline text-blue-500 ml-3">搜尋筆記</a>

  <!-- 聊天室 -->
  <div class="mt-6">
    <h2 class="font-bold text-xl">聊天室</h2>

    <div id="chatBox"
         class="h-60 overflow-y-auto border rounded p-3 bg-white"></div>

    <div class="flex mt-2 gap-2">
      <input id="chatInput" class="flex-1 border rounded p-2">
      <button id="sendChat" class="px-4 bg-green-600 text-white rounded">
        送出
      </button>
    </div>
  </div>

</div>

<!-- 放大圖片 Modal -->
<div id="imgModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
  <img id="modalImg" class="max-h-[90vh] rounded-xl">
</div>

<script>
  // ---------------- Firebase ----------------
  const firebaseConfig = {
    // 你的設定
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  auth.signInAnonymously(); // 若已登入 Google 可改成 onAuthStateChanged

  // ---------------- 富文字 ----------------
  const editor = document.getElementById("editor");

  fontSize.onchange = e => document.execCommand("fontSize", false, e.target.value);
  boldBtn.onclick = () => document.execCommand("bold");
  italicBtn.onclick = () => document.execCommand("italic");
  colorPicker.onchange = e => document.execCommand("foreColor", false, e.target.value);

  // ---------------- 附件管理 ----------------
  let attachments = [];

  imgUpload.onchange = e => {
    for (let f of e.target.files) {
      const r = new FileReader();
      r.onload = ev => {
        attachments.push(ev.target.result);
        attachmentsPreview.innerHTML += `
          <div class="p-2 bg-gray-200 rounded flex justify-between">
            <span>附件圖片</span>
            <button onclick="removeAttachment('${ev.target.result}')"
                    class="text-red-600">刪除</button>
          </div>
        `;
      };
      r.readAsDataURL(f);
    }
  };

  window.removeAttachment = src => {
    attachments = attachments.filter(x => x !== src);
    attachmentsPreview.innerHTML = "";
    attachments.forEach(a=>{
      attachmentsPreview.innerHTML += `
        <div class="p-2 bg-gray-200 rounded flex justify-between">
          <span>附件圖片</span>
          <button onclick="removeAttachment('${a}')" class="text-red-600">刪除</button>
        </div>
      `;
    });
  };

  // ---------------- 儲存筆記 ----------------
  saveNote.onclick = async () => {
    const user = auth.currentUser;

    await db.collection("notes").add({
      uid: user.uid,
      title: titleInput.value,
      content: editor.innerHTML,
      attachments: attachments,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    titleInput.value = "";
    editor.innerHTML = "";
    attachments = [];
    attachmentsPreview.innerHTML = "";
  };

  // ---------------- 聊天室 ----------------
  function scrollBottom() {
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  sendChat.onclick = async () => {
    const u = auth.currentUser;
    await db.collection("chat").add({
      uid: u.uid,
      text: chatInput.value,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    chatInput.value = "";
  };

  db.collection("chat")
    .orderBy("createdAt")
    .onSnapshot(snap => {
      chatBox.innerHTML = "";
      const docs = snap.docs.slice(-200); // 保留 200 則
      docs.forEach(d=>{
        chatBox.innerHTML += `
          <div class="p-2 bg-white rounded border mb-1">${d.data().text}</div>
        `;
      });
      scrollBottom();
    });

  // ---------------- 圖片放大 ----------------
  window.openImg = src => {
    modalImg.src = src;
    imgModal.classList.remove("hidden");
    imgModal.classList.add("flex");
  };
  imgModal.onclick = ()=> imgModal.classList.add("hidden");

</script>
</body>
</html>
