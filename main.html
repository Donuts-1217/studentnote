<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Main - NoteNote</title>

<style>
body{
  font-family:Arial;
  background:#f4f6ff;
  margin:0;
}
.top{
  background:#4c6ef5;
  color:white;
  padding:15px;
  display:flex;
  justify-content:space-between;
}
.editorBox{
  margin:20px;
  padding:15px;
  background:white;
  border-radius:12px;
  box-shadow:0 0 10px rgba(0,0,0,.1);
}
.toolbar button, .toolbar select, .toolbar input{
  margin-right:6px;
}
#editor{
  min-height:160px;
  border:1px solid #ccc;
  padding:10px;
  border-radius:10px;
}
.chatbox{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:220px;
  background:white;
  border-top:2px solid #ddd;
  display:flex;
  flex-direction:column;
}
#messages{
  flex:1;
  overflow-y:auto;
  padding:10px;
}
.msg{
  padding:6px 10px;
  border-radius:10px;
  background:#e9eeff;
  margin-bottom:6px;
}
</style>
</head>

<body>

<div class="top">
  <div>NoteNote 主頁</div>
  <div>
    <button onclick="location.href='allnotes.html'">所有筆記</button>
    <button onclick="location.href='search.html'">搜尋</button>
    <button id="logoutBtn">登出</button>
  </div>
</div>

<div class="editorBox">
  <h3>新增筆記</h3>

  <input id="titleInput" placeholder="標題" style="width:100%;font-size:16px;padding:8px">

  <div class="toolbar">
    <button onclick="format('bold')">粗體</button>
    <button onclick="format('italic')">斜體</button>
    <input type="color" id="colorPicker">
    <select id="fontSizeSelect">
      <option value="12px">12</option>
      <option value="14px">14</option>
      <option value="16px">16</option>
      <option value="18px">18</option>
      <option value="20px">20</option>
      <option value="22px">22</option>
      <option value="24px">24</option>
      <option value="28px">28</option>
      <option value="32px">32</option>
      <option value="36px">36</option>
    </select>

    <input type="file" id="imageInput" accept="image/*">
  </div>

  <div id="editor" contenteditable="true"></div>

  <button id="saveNoteBtn">儲存筆記</button>
</div>


<div class="chatbox">
  <div id="messages"></div>

  <div style="display:flex;padding:8px;">
    <input id="chatInput" style="flex:1;padding:8px" placeholder="輸入訊息…">
    <button id="sendBtn">送出</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { 
  getAuth, onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { 
  getFirestore, collection, addDoc, serverTimestamp,
  query, orderBy, limit, onSnapshot, deleteDoc, doc, getDocs
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain: "classquest-419e1.firebaseapp.com",
  projectId: "classquest-419e1",
  storageBucket: "classquest-419e1.firebasestorage.app",
  messagingSenderId: "18905423391",
  appId: "1:18905423391:web:37c3aa41f021430f27ff2a",
  measurementId: "G-0H7STZJVXS"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const editor = document.getElementById("editor");
const colorPicker = document.getElementById("colorPicker");
const fontSizeSelect = document.getElementById("fontSizeSelect");

window.format = (cmd)=>{
  document.execCommand(cmd,false,null);
};

colorPicker.addEventListener("change",()=>{
  document.execCommand("foreColor",false,colorPicker.value);
});

fontSizeSelect.addEventListener("change",()=>{
  const size = fontSizeSelect.value;
  document.execCommand("fontSize",false,7);
  const fonts = editor.getElementsByTagName("font");
  for(let f of fonts){
    if(f.size==="7"){
      f.removeAttribute("size");
      f.style.fontSize=size;
    }
  }
});

let imageBase64 = null;

document.getElementById("imageInput").addEventListener("change",e=>{
  const file = e.target.files[0];
  if(!file) return;

  if(!file.type.startsWith("image/")){
    alert("僅限圖片");
    return;
  }

  const reader = new FileReader();
  reader.onload = evt=> imageBase64 = evt.target.result;
  reader.readAsDataURL(file);
});


document.getElementById("saveNoteBtn").onclick = async ()=>{
  const user = auth.currentUser;
  if(!user) return;

  await addDoc(collection(db,"notes"),{
    uid:user.uid,
    userName:user.displayName || "unknown",
    title:document.getElementById("titleInput").value,
    content:editor.innerHTML,
    image:imageBase64 || null,
    createdAt:serverTimestamp()
  });

  alert("儲存完成");
  editor.innerHTML="";
  document.getElementById("titleInput").value="";
  imageBase64=null;
};


document.getElementById("logoutBtn").onclick = async ()=>{
  await signOut(auth);
  location.href="index.html";
};


const messagesDiv = document.getElementById("messages");
const chatInput = document.getElementById("chatInput");

document.getElementById("sendBtn").onclick = async ()=>{
  const user=auth.currentUser;
  if(!user) return;

  await addDoc(collection(db,"chat"),{
    uid:user.uid,
    name:user.displayName || "user",
    text:chatInput.value,
    createdAt:serverTimestamp()
  });

  chatInput.value="";
};

const q = query(collection(db,"chat"),orderBy("createdAt","asc"));

onSnapshot(q, async snapshot=>{
  messagesDiv.innerHTML="";

  if(snapshot.docs.length>200){
    const extra = snapshot.docs.length-200;
    for(let i=0;i<extra;i++){
      await deleteDoc(doc(db,"chat",snapshot.docs[i].id));
    }
  }

  snapshot.forEach(docItem=>{
    const d=docItem.data();
    const div=document.createElement("div");
    div.className="msg";
    div.textContent=`${d.name}: ${d.text}`;
    messagesDiv.appendChild(div);
  });

  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

onAuthStateChanged(auth,user=>{
  if(!user) location.href="index.html";
});
</script>

</body>
</html>
